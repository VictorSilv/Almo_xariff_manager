function doGet() {
  return HtmlService.createTemplateFromFile('Index')
    .evaluate()
    .setTitle('Almoxarifado Controlhe 2026')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

// Retorna lista de itens e stocks para o UI

// Retorna lista de itens e stocks para o UI
function getStockData() {
  const ss = getSpreadsheet();
  const agora = new Date();

  // 1. Carregar Usuários (Coluna B, linha 2 em diante)
  const userSheet = ss.getSheetByName('Usuários');
  const listaUsuarios = userSheet ? userSheet.getRange(2, 2, userSheet.getLastRow() - 1, 1).getValues().flat().filter(n => n !== "") : ["Admin"];

  
  // 2.  Mapeamento manual para garantir o match com 'Jan_2026', 'Fev_2026', etc.
  const sheet = getAbaMesAtual();
  
  if (!sheet) {
    Logger.log("Aba não encontrada: " + nomeAba);
    return [];
  }

  const lastRow = sheet.getLastRow();
  if (lastRow < 3) return []; // Se a tabela estiver vazia

  let listaStock = [];
  if (sheet) {
    const data = sheet.getRange(3, 1, sheet.getLastRow() - 2, 9).getValues();
    listaStock = data.map(r => ({ nome: r[0], disponivel: r[8] })).filter(r => r.nome !== "");
  }

  return { usuarios: listaUsuarios, stock: listaStock };
}

// Processa a retirada
function submitMultiplosItens(carrinho, responsavel) {
  const ss = getSpreadsheet();
  const agora = new Date();
  
  // Acessamos a aba do mês e o log usando subrotinas
  const sheet = getAbaMesAtual();
  const logSheet = ss.getSheetByName('Resumo') || ss.insertSheet('Resumo');

  const data = sheet.getDataRange().getValues();
  const COL_G = 7; // Índice da Coluna G

  // Itera sobre cada item no carrinho vindo do cliente
  for (let itemNome in carrinho) {
    let quantidade = Number(carrinho[itemNome]);
    if (quantidade <= 0) continue;

    // Encontra a linha do item na Coluna A (índice 0)
    for (let i = 2; i < data.length; i++) {
      if (data[i][0] === itemNome) {
        // Atualiza a célula do funcionário
        let celula = sheet.getRange(i + 1, COL_G);
        celula.setValue((Number(celula.getValue()) || 0) + quantidade);
        
        // Log no Resumo
        logSheet.appendRow([agora, itemNome, quantidade, responsavel]);
        break;
      }
    }
  }
  return true;
}

// --- SUBROTINAS UTILITÁRIAS ---

/**
 * Retorna o objeto SpreadsheetApp ativo.
 */
function getSpreadsheet() {
  return SpreadsheetApp.getActiveSpreadsheet();
}

/**
 * Retorna o nome da aba do mês atual no formato "Jan_2026", "Fev_2026", etc.
 */
function getNomeAbaMesAtual() {
  const agora = new Date();
  // Mapeamento manual para garantir o match com 'Jan_2026', 'Fev_2026', etc.
  const mesesAbrev = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
  const mesAbrev = mesesAbrev[agora.getMonth()];
  return mesAbrev + "_2026";
}

/**
 * Retorna a aba do mês atual. Lança um erro se não for encontrada.
 */
function getAbaMesAtual() {
  const ss = getSpreadsheet();
  const nomeAba = getNomeAbaMesAtual();
  const sheet = ss.getSheetByName(nomeAba);
  if (!sheet) {
    Logger.log("Aba não encontrada: " + nomeAba);
    throw new Error("Aba do mês não encontrada: " + nomeAba);
  }
  return sheet;
}

function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
