<script>
class AppSession {
  constructor() {
    this.items = [];
    this.usuarios = [];
    this.carrinho = {}; 
    this.usuarioAtivo = null;
    this.holdTimer = null;
    this.pressStartTime = 0;
    this.isScrolling = false;
    this.isLongPress = false;
    this.init();
    this.checkTheme();
  }

  async init() {
    this.showMsg("Sincronizando estoque...");
    google.script.run
      .withSuccessHandler(data => {
        this.items = data.stock;
        this.usuarios = data.usuarios;
        
        // Se j√° houver um usu√°rio logado (p√≥s-submiss√£o), redesenha a lista
        if (this.usuarioAtivo) {
          this.renderList();
        } else {
          this.renderUsers();
        }
      })
      .withFailureHandler(err => this.showMsg("Erro ao carregar: " + err))
      .getStockData();
  }

  renderUsers() {
    const grid = document.getElementById('userGrid');
    const cores = ['#3498db', '#e67e22', '#9b59b6', '#1abc9c', '#f1c40f', '#e74c3c'];
    grid.innerHTML = this.usuarios.map((u, i) => `
      <div class="user-card" style="background:${cores[i % cores.length]}" onclick="session.login('${u}')">
        ${u}
      </div>
    `).join('');
  }
  
  login(nome) {
    this.usuarioAtivo = nome;
    this.playLoginSound(); // Toca o som de entrada
    this.updateDynamicTitle();
    
    // Esconde login e mostra app com transi√ß√£o
    const loginScreen = document.getElementById('loginScreen');
    const appScreen = document.getElementById('appScreen');
    
    loginScreen.classList.add('hidden');
    
    setTimeout(() => {
      loginScreen.style.display = 'none';
      appScreen.style.display = 'block';
      
      // Mensagem de Boas-Vindas Amig√°vel
      this.showMsg(`Ol√°, ${nome}! O que vamos retirar hoje?`);
      
      setTimeout(() => {
        appScreen.classList.remove('hidden');
        document.getElementById('welcomeBanner').textContent = `Bom trabalho, ${nome}!`;
        document.getElementById('activeUser').innerHTML = `<b><i class="fas fa-user-circle"></i> ${nome}</b>`;
        this.renderList();
      }, 50);
    }, 500);
  }

  logout() {
    location.reload(); // Forma mais simples de resetar a sess√£o
  }

  updateDynamicTitle() {
    const meses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                   "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
    const mesAtual = meses[new Date().getMonth()];
    const titleElem = document.getElementById('dynamicTitle');
    
    if (titleElem) {
      titleElem.innerHTML = `<i class="fas fa-warehouse"></i> Almoxarifado ${mesAtual} 2026`;
    }
  }

  handleTouchStart(nomeItem) {
    this.isScrolling = false;
    this.pressStartTime = Date.now();
    this.isLongPress = false;

    // Timer para o Long Press (Edi√ß√£o Manual)
    this.holdTimer = setTimeout(() => {
      this.isLongPress = true;
      this.abrirEditorManual(nomeItem);
    }, 800); // Aumentamos para 800ms para dar margem ao scroll
  }

  handleTouchMove() {
    // Se o utilizador mexer o dedo, √© um scroll, n√£o um clique
    this.isScrolling = true;
    clearTimeout(this.holdTimer);
  }

  handleTouchEnd(nomeItem) {
    clearTimeout(this.holdTimer);
    const duration = Date.now() - this.pressStartTime;

    // S√ì ADICIONA 'tap' SE:
    // 1. N√£o foi um scroll (isScrolling)
    // 2. N√£o foi um long press
    // 3. O toque teve uma dura√ß√£o m√≠nima "org√¢nica" (ex: entre 50ms e 300ms)
    if (!this.isScrolling && !this.isLongPress) {
      if (duration > 50) { 
        this.adicionarUm(nomeItem);
      }
    }
  }

  
      handleSearch() {
        const valor = document.getElementById('itemInput').value.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      
      // Seleciona todos os cards gerados no monitor
      const cards = document.querySelectorAll('.stock-item-card');
      
      cards.forEach(card => {
        // Pega o nome do item dentro do span do card
        const nomeItem = card.querySelector('.item-name').textContent.toLowerCase()
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        
        // L√≥gica: Se o nome cont√©m o que foi digitado, mostra. Se n√£o, esconde.
        if (nomeItem.includes(valor)) {
          card.style.display = "flex"; // Ou o display original (flex/block)
          card.style.opacity = "1";
        } else {
          card.style.display = "none";
          card.style.opacity = "0";
        }
        });
      }

      renderList() {
        const monitor = document.getElementById('stockMonitor');
        if (!monitor) return;

        if (!this.items || this.items.length === 0) {
          const nomesMeses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", 
                              "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
          const mesAtual = nomesMeses[new Date().getMonth()];
          monitor.innerHTML = `<p style='text-align:center; opacity:0.6;'>Nenhum item cadastrado em ${mesAtual}.</p>`;
          this.showMsg("Aviso: Nenhum item encontrado no estoque de " + mesAtual);
          return;
        }
        
        // 2. Monitor de Cards
        monitor.innerHTML = `<h3 style="margin: 20px 0 10px 5px;"><i class="fas fa-boxes-stacked"></i> Itens no Almoxarifado</h3>
          <div class="monitor-grid">
            ${this.items.map(i => {
              const selecionado = this.carrinho[i.nome] || 0;
              return `
                <div class="stock-item-card" 
                    onmousedown="if(event.button === 0) session.handleTouchStart('${i.nome}');"
                    oncontextmenu="session.subtrairUm(event, '${i.nome}')"
                    onmouseup="if(event.button === 0) session.handleTouchEnd('${i.nome}');"
                    ontouchstart="session.handleTouchStart('${i.nome}')" 
                    ontouchmove="session.handleTouchMove()"
                    ontouchend="session.handleTouchEnd('${i.nome}')">
                  ${selecionado > 0 ? `<div class="selection-badge">${selecionado}</div>` : ''}
                  <span class="item-name">${i.nome}</span>
                  <div class="item-badge ${i.disponivel <= 2 ? 'bad-qty' : 'good-qty'}">
                    ${i.disponivel}
                  </div>
                </div>
              `;
            }).join('')}
          </div>`;

        // 3. Re-aplica o filtro com as chavetas corrigidas
        setTimeout(() => {
          const inputFiltro = document.getElementById('itemInput');
          if (inputFiltro && inputFiltro.value.length > 0) {
            this.handleSearch(); 
          } else {
            this.showMsg("Estoque sincronizado!");
          } // Fecho do else
        }, 10); // Fecho do setTimeout
      }


      // Fun√ß√£o para clicar e adicionar +1
        adicionarUm(nomeItem) {
          const item = this.items.find(i => i.nome === nomeItem);
          if (!item) return;

          const atualNoCarrinho = this.carrinho[nomeItem] || 0;
          
          if (atualNoCarrinho < item.disponivel) {
            this.carrinho[nomeItem] = atualNoCarrinho + 1;
            this.playPopSound(); // Toca o pop ao clicar no card
    
            this.renderList(); // Re-renderiza para mostrar o badge
          } else {
            this.showMsg("‚ö†Ô∏è Limite de stock atingido!");
          }
        }
      //Fun√ß√£o pra clicar e subtrair -1
        subtrairUm(event, nomeItem) {
          // Impede o menu de contexto (bot√£o direito) de aparecer
          if (event) event.preventDefault();

          if (this.carrinho[nomeItem]) {
            this.carrinho[nomeItem] -= 1;
            this.playPopSound(); // Som de feedback (podes fazer um som mais grave se quiseres)
            
            // Se chegar a zero, removemos do carrinho para limpar o badge
            if (this.carrinho[nomeItem] <= 0) {
              delete this.carrinho[nomeItem];
            }
            this.renderList();
          }
        }


    submit() {
    const itensNoCarrinho = Object.entries(this.carrinho).filter(([_, qtd]) => qtd > 0);
    const responsavel = this.usuarioAtivo; 

    if (itensNoCarrinho.length === 0) {
      this.showMsg("Selecione itens clicando nos cards!");
      return;
    }

    const resumoTexto = itensNoCarrinho.map(([nome, qtd]) => `${qtd}x ${nome}`).join(', ');
    this.abrirModalConfirmacao(resumoTexto, responsavel);
  }

  abrirModalConfirmacao(resumo, quem) {
      const modal = document.createElement('div');
      modal.id = "modalConfirm";
      modal.className = "modal-overlay";
      modal.innerHTML = `
        <div class="modal-content">
          <h3>Confirmar Retirada</h3>
          <p><strong>${quem}</strong>, confirmar a sa√≠da de:</p>
          <p style="font-size:0.9em; color:gray;">${resumo}</p>
          <div class="modal-btns">
            <button class="btn-confirm" onclick="session.processarSubmissao()">Sim, Confirmar</button>
            <button class="btn-cancel" onclick="session.fecharModal()">Cancelar</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Corre√ß√£o do Erro: Usa o ID do ecr√£ principal para o blur
      document.getElementById('appScreen').classList.add('blur-bg');
  }

    fecharModal() {
      const modal = document.getElementById('modalConfirm');
      if (modal) modal.remove();
      document.getElementById('appScreen').classList.remove('blur-bg');
    }

    async processarSubmissao() {
    const btn = document.getElementById('submitBtn');
    this.fecharModal();
    
    document.body.classList.add('processing');
    if(btn) btn.disabled = true;

    google.script.run
      .withSuccessHandler(() => {
        this.playSuccessSound();
        this.showMsg("‚úÖ Retirada conclu√≠da!");
        
        // IMPORTANTE: Limpa o carrinho local ANTES de dar o init
        this.carrinho = {}; 
        this.resetForm();
      })
      .withFailureHandler(err => {
        this.showMsg("‚ùå Erro: " + err);
        document.body.classList.remove('processing');
        if(btn) btn.disabled = false;
      })
      .submitMultiplosItens(this.carrinho, this.usuarioAtivo);
  }

  resetForm() {
    // Limpa o processamento visual
    document.body.classList.remove('processing');
    
    // Reativa o bot√£o
    const btn = document.getElementById('submitBtn');
    if (btn) btn.disabled = false;

    // Limpa o texto da busca para n√£o filtrar o novo estoque
    const inputFiltro = document.getElementById('itemInput');
    if (inputFiltro) inputFiltro.value = '';

    // Recarrega os dados do servidor (o renderList ser√° chamado no sucesso do init)
    this.init(); 
  }


  checkTheme() {
    const isDark = localStorage.getItem('dark-mode') === 'true';
    if (isDark) {
      document.body.classList.add('dark-mode');
    }
    this.updateThemeIcon(isDark);
  }
  
  updateThemeIcon(isDark) {
    const btn = document.getElementById('themeToggle');
    if (btn) {
      btn.textContent = isDark ? '‚òÄÔ∏è' : '‚ö´';
    }
  }

  toggleDarkMode() {
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('dark-mode', isDark);
    this.updateThemeIcon(isDark);
    this.playSuccessSound; // Um feedback sonoro na troca de tema fica √≥timo!
  }
  
  showMsg(message) {
    const div = document.getElementById('msgDiv');
    div.textContent = message;
    div.style.display = 'block';
    
    // Pequena anima√ß√£o de fade-out
    setTimeout(() => {
      div.style.display = 'none';
    }, 4000);
  }

    // Gera um som de "Pop" curto e agudo
  playPopSound() {
    const context = new (window.AudioContext || window.webkitAudioContext)();
    const osc = context.createOscillator();
    const gain = context.createGain();

    osc.type = 'sine';
    osc.frequency.setValueAtTime(600, context.currentTime);
    osc.frequency.exponentialRampToValueAtTime(100, context.currentTime + 0.1);

    gain.gain.setValueAtTime(0.2, context.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.1);

    osc.connect(gain);
    gain.connect(context.destination);

    osc.start();
    osc.stop(context.currentTime + 0.1);
  }

  // Gera uma nota feliz (acorde ascendente)
  playSuccessSound() {
    const context = new (window.AudioContext || window.webkitAudioContext)();
    const notas = [523.25, 659.25, 783.99]; // D√≥, Mi, Sol (C5, E5, G5)
    
    notas.forEach((freq, i) => {
      const osc = context.createOscillator();
      const gain = context.createGain();
      
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(freq, context.currentTime + (i * 0.1));
      
      gain.gain.setValueAtTime(0.1, context.currentTime + (i * 0.1));
      gain.gain.exponentialRampToValueAtTime(0.01, context.currentTime + (i * 0.1) + 0.3);
      
      osc.connect(gain);
      gain.connect(context.destination);
      
      osc.start(context.currentTime + (i * 0.1));
      osc.stop(context.currentTime + (i * 0.1) + 0.3);
    });
  }
  // Som de Arpejo Feliz para o Login
  playLoginSound() {
    const context = new (window.AudioContext || window.webkitAudioContext)();
    const notas = [261.63, 329.63, 392.00, 523.25]; // D√≥, Mi, Sol, D√≥ (C4, E4, G4, C5)
    
    notas.forEach((freq, i) => {
      const osc = context.createOscillator();
      const gain = context.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, context.currentTime + (i * 0.08));
      gain.gain.setValueAtTime(0.1, context.currentTime + (i * 0.08));
      gain.gain.exponentialRampToValueAtTime(0.01, context.currentTime + (i * 0.08) + 0.4);
      osc.connect(gain);
      gain.connect(context.destination);
      osc.start(context.currentTime + (i * 0.08));
      osc.stop(context.currentTime + (i * 0.08) + 0.4);
    });
  }

  // L√≥gica de Press√£o Longa
  startPress(nomeItem) {
    this.isLongPress = false;
    this.holdTimer = setTimeout(() => {
      this.isLongPress = true;
      this.abrirEditorManual(nomeItem);
    }, 600); // 600ms para considerar "long hold"
  }

  endPress(nomeItem) {
    clearTimeout(this.holdTimer);
    if (!this.isLongPress) {
      this.adicionarUm(nomeItem);
    }
  }
  // Atualizar o HTML da modal dentro de abrirEditorManual:
  abrirEditorManual(nomeItem) {
    const item = this.items.find(i => i.nome === nomeItem);
    const qtdAtual = this.carrinho[nomeItem] || 0;
    
    const modal = document.createElement('div');
    modal.className = "modal-overlay";
    modal.id = "editorManual";
    modal.innerHTML = `
      <div class="modal-edit">
        <h4><i class="fas fa-edit">Editar: </i> ${nomeItem}</h4>
        <input type="number" id="manualQty" class="edit-input" value="${qtdAtual}" min="0" max="${item.disponivel}">
        <p><small>M√°ximo dispon√≠vel: ${item.disponivel}</small></p>
        <div class="modal-btns">
          <button class="btn-confirm" onclick="session.salvarEdicao('${nomeItem}')">OK</button>
          <button class="btn-cancel" onclick="session.removerItemManual('${nomeItem}')">Remover</button>
        </div>
        <button class="btn-text" style="margin-top:10px; background:none; border:none; color:gray; cursor:pointer" onclick="session.fecharEditor()">Voltar</button>
      </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('manualQty').focus();
  }

  salvarEdicao(nomeItem) {
    const input = document.getElementById('manualQty');
    const novaQtd = parseInt(input.value);
    const item = this.items.find(i => i.nome === nomeItem);
    
    if (novaQtd <= item.disponivel) {
      this.carrinho[nomeItem] = novaQtd;
      this.renderList();
      this.fecharEditor();
  
    } else {
      this.showMsg(`M√°ximo dispon√≠vel: ${item.disponivel}`);
      input.value = item.disponivel; // Sugere o m√°ximo autom√°tico
    }
  }

  fecharEditor() {
    const modal = document.getElementById('editorManual');
    if (modal) modal.remove();
    
    // CORRE√á√ÉO: Usa o ID correto para remover o blur
    const appContainer = document.getElementById('appScreen');
    if (appContainer) {
      appContainer.classList.remove('blur-bg');
    }
    
    this.isLongPress = false; // Reset de seguran√ßa
  }

  // Remova a vers√£o duplicada e mantenha apenas esta:
  removerItemManual(nomeItem) {
    if (this.carrinho[nomeItem]) {
      delete this.carrinho[nomeItem]; 
      this.renderList();
      this.playPopSound();
      this.showMsg(`üóëÔ∏è Sele√ß√£o de ${nomeItem} removida.`);
    }
    this.fecharEditor();
  }






} // <-- fim da classe AppSession

const session = new AppSession();
</script>
